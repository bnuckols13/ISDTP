<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISTDP Training Platform | Advanced Clinical Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Sophisticated Clinical Palette */
            --primary: #2C4A52;
            --primary-light: #4A6572;
            --primary-dark: #1A2F35;
            
            --accent: #7BA098;
            --accent-light: #A3C4BC;
            --accent-dark: #5A8078;
            
            --warm: #C17767;
            --warm-light: #D4A59A;
            --warm-dark: #9B5A4F;
            
            --neutral-100: #FAFBFC;
            --neutral-200: #F3F4F6;
            --neutral-300: #E5E7EB;
            --neutral-400: #D1D5DB;
            --neutral-500: #9CA3AF;
            --neutral-600: #6B7280;
            --neutral-700: #4B5563;
            --neutral-800: #374151;
            --neutral-900: #1F2937;
            
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            
            /* Typography Scale */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        /* Typography */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: var(--text-base);
            line-height: 1.6;
            color: var(--neutral-800);
            background: var(--neutral-100);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
            color: var(--primary-dark);
        }

        h1 { font-size: var(--text-3xl); }
        h2 { font-size: var(--text-2xl); }
        h3 { font-size: var(--text-xl); }
        h4 { font-size: var(--text-lg); }

        /* Layout */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--space-8) var(--space-6);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header h1 {
            color: white;
            margin-bottom: var(--space-2);
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: var(--text-lg);
            font-weight: 400;
        }

        /* Navigation */
        .navigation {
            background: white;
            border-bottom: 1px solid var(--neutral-300);
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-6);
        }

        .nav-tabs {
            display: flex;
            gap: var(--space-1);
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: var(--space-4) var(--space-6);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--neutral-600);
            font-weight: 500;
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-tab:hover {
            color: var(--primary);
            background: var(--neutral-100);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
            background: var(--neutral-100);
        }

        .nav-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--error);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: var(--text-xs);
            font-weight: 700;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-8) var(--space-6);
            width: 100%;
        }

        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: var(--space-6);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--neutral-200);
            background: var(--neutral-100);
        }

        .card-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .card-header .icon {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: var(--text-lg);
        }

        .card-body {
            padding: var(--space-6);
        }

        /* Triangle of Conflict */
        .triangle-visualization {
            padding: var(--space-12) var(--space-6);
            background: linear-gradient(135deg, var(--neutral-100) 0%, var(--neutral-200) 100%);
            border-radius: 12px;
            margin: var(--space-6) 0;
        }

        .triangle-svg {
            max-width: 500px;
            margin: 0 auto;
            display: block;
        }

        .triangle-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .triangle-node:hover {
            transform: scale(1.05);
        }

        .triangle-node.active {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .triangle-info {
            background: white;
            border-radius: 8px;
            padding: var(--space-6);
            margin-top: var(--space-6);
            box-shadow: var(--shadow);
            min-height: 150px;
        }

        /* Twin Factors */
        .formula-display {
            background: var(--primary-dark);
            color: white;
            padding: var(--space-8);
            border-radius: 12px;
            text-align: center;
            margin: var(--space-6) 0;
        }

        .formula-display h3 {
            color: white;
            font-size: var(--text-2xl);
            margin-bottom: var(--space-6);
            font-weight: 300;
            letter-spacing: 0.05em;
        }

        .formula-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--space-6);
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .formula-component {
            background: rgba(255, 255, 255, 0.1);
            padding: var(--space-6);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .formula-operator {
            font-size: var(--text-3xl);
            color: var(--accent-light);
        }

        /* Scenarios */
        .scenario-container {
            background: var(--neutral-100);
            border-radius: 12px;
            padding: var(--space-6);
            margin: var(--space-6) 0;
        }

        .patient-statement {
            background: white;
            border-left: 4px solid var(--warm);
            padding: var(--space-6);
            border-radius: 4px;
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
        }

        .patient-label {
            text-transform: uppercase;
            font-size: var(--text-sm);
            font-weight: 700;
            color: var(--warm);
            margin-bottom: var(--space-3);
            letter-spacing: 0.05em;
        }

        .patient-text {
            color: var(--neutral-700);
            font-size: var(--text-lg);
            line-height: 1.7;
            font-style: italic;
        }

        /* Response Options */
        .response-options {
            display: grid;
            gap: var(--space-4);
        }

        .response-option {
            background: white;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            padding: var(--space-5);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .response-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: transparent;
            transition: all 0.2s ease;
        }

        .response-option:hover {
            border-color: var(--accent);
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        .response-option:hover::before {
            background: var(--accent);
        }

        .response-option.selected {
            border-color: var(--primary);
            background: var(--neutral-100);
        }

        .response-option.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .response-option.correct::before {
            background: var(--success);
        }

        .response-option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .response-option.incorrect::before {
            background: var(--error);
        }

        .response-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--space-2);
        }

        /* Feedback Panel */
        .feedback-panel {
            background: white;
            border-radius: 8px;
            padding: var(--space-6);
            margin-top: var(--space-6);
            box-shadow: var(--shadow-md);
            display: none;
            border: 2px solid var(--primary);
        }

        .feedback-panel.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--neutral-200);
        }

        .score-display {
            background: var(--primary);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: 20px;
            font-weight: 700;
            font-size: var(--text-lg);
        }

        /* Progress Indicators */
        .progress-card {
            background: white;
            border-radius: 8px;
            padding: var(--space-6);
            box-shadow: var(--shadow);
            margin-bottom: var(--space-6);
        }

        .progress-bar {
            height: 8px;
            background: var(--neutral-200);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--space-4) 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dark) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-6);
        }

        .metric-card {
            background: var(--neutral-100);
            padding: var(--space-4);
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--neutral-200);
        }

        .metric-value {
            font-size: var(--text-3xl);
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .metric-label {
            font-size: var(--text-sm);
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-2);
        }

        /* Rubric Table */
        .rubric-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: var(--space-6) 0;
        }

        .rubric-table thead {
            background: var(--primary-dark);
            color: white;
        }

        .rubric-table th {
            padding: var(--space-4);
            text-align: left;
            font-weight: 600;
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .rubric-table th:first-child {
            border-top-left-radius: 8px;
        }

        .rubric-table th:last-child {
            border-top-right-radius: 8px;
        }

        .rubric-table tbody tr {
            transition: all 0.2s ease;
        }

        .rubric-table tbody tr:hover {
            background: var(--neutral-100);
        }

        .rubric-table td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--neutral-200);
        }

        .competency-level {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: 12px;
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .level-high {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .level-medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .level-low {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Buttons */
        .btn {
            padding: var(--space-3) var(--space-6);
            border-radius: 6px;
            font-weight: 600;
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--neutral-100);
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
            color: white;
            padding: var(--space-4) var(--space-6);
            border-radius: 8px;
            margin: var(--space-4) 0;
        }

        .info-box h4 {
            color: white;
            margin-bottom: var(--space-2);
        }

        /* Clinical Note */
        .clinical-note {
            background: var(--neutral-100);
            border-left: 4px solid var(--accent);
            padding: var(--space-4);
            border-radius: 4px;
            margin: var(--space-4) 0;
        }

        .clinical-note strong {
            color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: var(--space-4);
            }
            
            .formula-grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .formula-operator {
                transform: rotate(90deg);
                margin: var(--space-4) 0;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tab {
                padding: var(--space-3) var(--space-4);
            }
        }

        /* Print Styles */
        @media print {
            .navigation, .btn, .response-option {
                display: none;
            }
            
            .card {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>ISTDP Advanced Training Platform</h1>
                <p class="header-subtitle">Master Intensive Short-Term Dynamic Psychotherapy Through Clinical Practice</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="navigation">
            <div class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showPage(0)">
                        Core Theory
                    </button>
                    <button class="nav-tab" onclick="showPage(1)">
                        Present-Moment Training
                    </button>
                    <button class="nav-tab" onclick="showPage(2)">
                        Clinical Scenarios
                        <span class="nav-indicator">3</span>
                    </button>
                    <button class="nav-tab" onclick="showPage(3)">
                        Assessment
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page 1: Core Theory -->
            <div class="page active" id="page0">
                <div class="card">
                    <div class="card-header">
                        <h2>
                            <span class="icon">▲</span>
                            The Triangle of Conflict
                        </h2>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--neutral-600); margin-bottom: var(--space-6);">
                            Every patient response can be mapped onto this fundamental framework. Select each component to explore its clinical significance.
                        </p>
                        
                        <div class="triangle-visualization">
                            <svg class="triangle-svg" viewBox="0 0 400 350" xmlns="http://www.w3.org/2000/svg">
                                <!-- Triangle Lines -->
                                <line x1="200" y1="50" x2="100" y2="250" stroke="#4A6572" stroke-width="2" stroke-dasharray="5,5"/>
                                <line x1="200" y1="50" x2="300" y2="250" stroke="#4A6572" stroke-width="2" stroke-dasharray="5,5"/>
                                <line x1="100" y1="250" x2="300" y2="250" stroke="#4A6572" stroke-width="2" stroke-dasharray="5,5"/>
                                
                                <!-- Nodes -->
                                <g class="triangle-node" onclick="showTriangleInfo('feeling')">
                                    <circle cx="200" cy="50" r="45" fill="#C17767"/>
                                    <text x="200" y="50" text-anchor="middle" dy="0" fill="white" font-weight="600" font-size="14">FEELING</text>
                                    <text x="200" y="65" text-anchor="middle" dy="0" fill="white" font-size="11">Impulse</text>
                                </g>
                                
                                <g class="triangle-node" onclick="showTriangleInfo('anxiety')">
                                    <circle cx="100" cy="250" r="45" fill="#F59E0B"/>
                                    <text x="100" y="255" text-anchor="middle" dy="0" fill="white" font-weight="600" font-size="14">ANXIETY</text>
                                </g>
                                
                                <g class="triangle-node" onclick="showTriangleInfo('defense')">
                                    <circle cx="300" cy="250" r="45" fill="#7BA098"/>
                                    <text x="300" y="255" text-anchor="middle" dy="0" fill="white" font-weight="600" font-size="14">DEFENSE</text>
                                </g>
                            </svg>
                        </div>

                        <div class="triangle-info" id="triangleDescription">
                            <h4>Select a component to explore its clinical significance</h4>
                            <p style="color: var(--neutral-600);">Understanding this framework is fundamental to every ISTDP intervention.</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>
                            <span class="icon">=</span>
                            The Twin Factors Formula
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="formula-display">
                            <h3>PRESSURE + SUPPORT = THERAPEUTIC CHANGE</h3>
                            <div class="formula-grid">
                                <div class="formula-component">
                                    <h4 style="color: var(--warm-light); margin-bottom: var(--space-3);">PRESSURE</h4>
                                    <p style="margin-bottom: var(--space-3);">Systematic challenging of defensive structures</p>
                                    <ul style="text-align: left; font-size: var(--text-sm); opacity: 0.9;">
                                        <li>Address entire defensive wall</li>
                                        <li>Maintain present focus</li>
                                        <li>Block temporal displacement</li>
                                    </ul>
                                </div>
                                <div class="formula-operator">+</div>
                                <div class="formula-component">
                                    <h4 style="color: var(--accent-light); margin-bottom: var(--space-3);">SUPPORT</h4>
                                    <p style="margin-bottom: var(--space-3);">Co-regulation and secure attachment</p>
                                    <ul style="text-align: left; font-size: var(--text-sm); opacity: 0.9;">
                                        <li>Acknowledge anxiety directly</li>
                                        <li>Offer collaborative regulation</li>
                                        <li>Create corrective experience</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="clinical-note">
                            <strong>Critical Principle:</strong> Collusion with defenses constitutes clinical abandonment. Supporting defensive structures perpetuates suffering and enables destructive enactments.
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>
                            <span class="icon">◉</span>
                            Somatic Manifestations
                        </h2>
                    </div>
                    <div class="card-body">
                        <h3 style="margin-bottom: var(--space-4);">Anxiety Channel Recognition</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                            <div class="clinical-note" style="border-left-color: var(--success);">
                                <h4 style="color: var(--success); margin-bottom: var(--space-3);">Striated Muscle (Manageable)</h4>
                                <ul style="color: var(--neutral-700); font-size: var(--text-sm);">
                                    <li>Muscular tension</li>
                                    <li>Hand-wringing behaviors</li>
                                    <li>Respiratory sighing</li>
                                    <li>Generally tolerable manifestations</li>
                                </ul>
                            </div>
                            <div class="clinical-note" style="border-left-color: var(--error);">
                                <h4 style="color: var(--error); margin-bottom: var(--space-3);">Smooth Muscle (Requires Immediate Regulation)</h4>
                                <ul style="color: var(--neutral-700); font-size: var(--text-sm);">
                                    <li>Gastrointestinal distress</li>
                                    <li>Vestibular symptoms</li>
                                    <li>Urinary urgency</li>
                                    <li>Vascular migraines</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Present-Moment Training -->
            <div class="page" id="page1">
                <div class="card">
                    <div class="card-header">
                        <h2>
                            <span class="icon">◆</span>
                            Present-Moment Intervention Training
                        </h2>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--neutral-600); margin-bottom: var(--space-6);">
                            Master the fundamental intervention: redirecting attention to immediate therapeutic dynamics.
                        </p>

                        <div class="scenario-container">
                            <h3 style="margin-bottom: var(--space-4);">Clinical Vignette</h3>
                            <div class="patient-statement">
                                <div class="patient-label">Patient Statement</div>
                                <p class="patient-text">
                                    "I'm worried about the family dinner this weekend. I know I'm going to end up binging afterward like I always do. It's just so stressful being around my mother..."
                                </p>
                            </div>

                            <h4 style="color: var(--primary); margin-bottom: var(--space-4);">Select Your Clinical Response:</h4>
                            <div class="response-options">
                                <div class="response-option" onclick="checkPresentMoment(this, 'displacement')">
                                    <span class="response-label">Response A</span>
                                    <p>"Tell me more about what happens at these family dinners."</p>
                                </div>
                                <div class="response-option" onclick="checkPresentMoment(this, 'correct')">
                                    <span class="response-label">Response B</span>
                                    <p>"I wonder if there might be something about this moment, here with me, that could be bringing up thoughts about Saturday? Would it be helpful to explore that together?"</p>
                                </div>
                                <div class="response-option" onclick="checkPresentMoment(this, 'support-only')">
                                    <span class="response-label">Response C</span>
                                    <p>"That sounds really difficult. It must be hard anticipating that stress."</p>
                                </div>
                                <div class="response-option" onclick="checkPresentMoment(this, 'advice')">
                                    <span class="response-label">Response D</span>
                                    <p>"Have you considered setting boundaries with your mother?"</p>
                                </div>
                            </div>

                            <div id="presentMomentFeedback" class="feedback-panel">
                                <!-- Feedback will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>
                            <span class="icon">→</span>
                            The Collusion-Enactment Pathway
                        </h2>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6);">
                            <div class="clinical-note" style="border-left-color: var(--error); background: rgba(239, 68, 68, 0.05);">
                                <h3 style="color: var(--error);">Pathological Cycle</h3>
                                <ol style="color: var(--neutral-700); line-height: 2;">
                                    <li><strong>Defense Supported</strong> → Affect remains unconscious</li>
                                    <li><strong>Internal Pressure Builds</strong> → Requires discharge</li>
                                    <li><strong>Behavioral Enactment</strong> → Self-destructive action</li>
                                </ol>
                            </div>

                            <div class="clinical-note" style="border-left-color: var(--success); background: rgba(16, 185, 129, 0.05);">
                                <h3 style="color: var(--success);">Therapeutic Intervention</h3>
                                <ol style="color: var(--neutral-700); line-height: 2;">
                                    <li><strong>Defense Challenged</strong> → Affect emerges</li>
                                    <li><strong>In-Session Processing</strong> → Metabolization</li>
                                    <li><strong>Enactment Prevented</strong> → Harm reduction</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 3: Clinical Scenarios -->
            <div class="page" id="page2">
                <div class="progress-card">
                    <h3>Training Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="scenarioProgress" style="width: 0%;"></div>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <span class="metric-value" id="scenarioCount">0</span>
                            <span class="metric-label">Completed</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value" id="avgScore">0%</span>
                            <span class="metric-label">Average Score</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value" id="streakCount">0</span>
                            <span class="metric-label">Optimal Responses</span>
                        </div>
                    </div>
                </div>

                <div class="card" id="scenario1">
                    <div class="card-header">
                        <h2>
                            <span class="icon">1</span>
                            Clinical Scenario: Anxiety Regulation
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="scenario-container">
                            <div class="patient-statement">
                                <div class="patient-label">Patient Presentation</div>
                                <p class="patient-text">
                                    "I'm getting really dizzy right now... but it's fine, I'm used to it. This always happens when I talk about feelings. My doctor says it's just my anxiety disorder acting up."
                                </p>
                            </div>

                            <h4 style="color: var(--primary); margin-bottom: var(--space-4);">Select Your Intervention:</h4>
                            <div class="response-options" id="scenario1Options">
                                <div class="response-option" onclick="evaluateResponse(1, 'A', this)">
                                    <span class="response-label">Intervention A</span>
                                    <p>"Oh, that must be uncomfortable. Take your time."</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(1, 'B', this)">
                                    <span class="response-label">Intervention B</span>
                                    <p>"It sounds like that might be anxiety. Sometimes when we feel anxious it can cause dizziness. Would it be helpful if we looked at it together so you might feel more comfortable?"</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(1, 'C', this)">
                                    <span class="response-label">Intervention C</span>
                                    <p>"Your anxiety disorder sounds challenging. What does your doctor recommend?"</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(1, 'D', this)">
                                    <span class="response-label">Intervention D</span>
                                    <p>"Let's take a break until you feel better."</p>
                                </div>
                            </div>

                            <div id="scenario1Feedback" class="feedback-panel">
                                <!-- Feedback will appear here -->
                            </div>

                            <button class="btn btn-primary" onclick="nextScenario(2)" style="display: none; margin-top: var(--space-4);" id="next1">
                                Proceed to Next Scenario
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" id="scenario2" style="display: none;">
                    <div class="card-header">
                        <h2>
                            <span class="icon">2</span>
                            Clinical Scenario: Defensive Operations
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="scenario-container">
                            <div class="patient-statement">
                                <div class="patient-label">Patient Presentation</div>
                                <p class="patient-text">
                                    "I don't see why my feelings matter. I mean, what's the point? I should just focus on practical solutions. Actually, I need to use the bathroom... sorry, I'll be right back."
                                </p>
                            </div>

                            <h4 style="color: var(--primary); margin-bottom: var(--space-4);">Select Your Intervention:</h4>
                            <div class="response-options" id="scenario2Options">
                                <div class="response-option" onclick="evaluateResponse(2, 'A', this)">
                                    <span class="response-label">Intervention A</span>
                                    <p>"Of course, take your time. The bathroom is down the hall."</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(2, 'B', this)">
                                    <span class="response-label">Intervention B</span>
                                    <p>"I'm noticing that perhaps when we get close to feelings, there might be an urge to leave. Would it be okay if we explored what might be happening here together?"</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(2, 'C', this)">
                                    <span class="response-label">Intervention C</span>
                                    <p>"Your feelings matter because they're driving your behavior. Let's explore practical solutions after."</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(2, 'D', this)">
                                    <span class="response-label">Intervention D</span>
                                    <p>"It sounds like you're not ready to explore feelings today."</p>
                                </div>
                            </div>

                            <div id="scenario2Feedback" class="feedback-panel">
                                <!-- Feedback will appear here -->
                            </div>

                            <button class="btn btn-primary" onclick="nextScenario(3)" style="display: none; margin-top: var(--space-4);" id="next2">
                                Proceed to Next Scenario
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" id="scenario3" style="display: none;">
                    <div class="card-header">
                        <h2>
                            <span class="icon">3</span>
                            Clinical Scenario: Attachment Dynamics
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="scenario-container">
                            <div class="patient-statement">
                                <div class="patient-label">Patient Presentation</div>
                                <p class="patient-text">
                                    "You're just like everyone else. You act like you care, but you're just doing your job. I bet you forget about me the second I walk out that door. Why should I open up to you?"
                                </p>
                            </div>

                            <h4 style="color: var(--primary); margin-bottom: var(--space-4);">Select Your Intervention:</h4>
                            <div class="response-options" id="scenario3Options">
                                <div class="response-option" onclick="evaluateResponse(3, 'A', this)">
                                    <span class="response-label">Intervention A</span>
                                    <p>"I do care about you and all my patients. This is more than just a job to me."</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(3, 'B', this)">
                                    <span class="response-label">Intervention B</span>
                                    <p>"It seems like there might be some anger toward me right now. I wonder what you might be experiencing in your body as you share this with me?"</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(3, 'C', this)">
                                    <span class="response-label">Intervention C</span>
                                    <p>"It sounds like you've been hurt by people you trusted before."</p>
                                </div>
                                <div class="response-option" onclick="evaluateResponse(3, 'D', this)">
                                    <span class="response-label">Intervention D</span>
                                    <p>"What makes you think I don't care?"</p>
                                </div>
                            </div>

                            <div id="scenario3Feedback" class="feedback-panel">
                                <!-- Feedback will appear here -->
                            </div>

                            <button class="btn btn-primary" onclick="showProgress()" style="display: none; margin-top: var(--space-4);" id="next3">
                                View Competency Assessment
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: Assessment -->
            <div class="page" id="page3">
                <div class="card">
                    <div class="card-header">
                        <h2>
                            <span class="icon">★</span>
                            ISTDP Competency Assessment
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="progress-card" style="background: var(--primary); color: white; text-align: center;">
                            <h3 style="color: white;">Overall Clinical Performance</h3>
                            <div style="font-size: 4rem; font-weight: 700; margin: var(--space-4) 0;" id="finalScore">0%</div>
                            <div style="font-size: var(--text-lg); opacity: 0.9;" id="performanceLevel">Novice Practitioner</div>
                        </div>

                        <h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">Competency Rubric Assessment</h3>
                        <table class="rubric-table">
                            <thead>
                                <tr>
                                    <th>Clinical Competency</th>
                                    <th>Performance Level</th>
                                    <th>Expert Recommendation</th>
                                </tr>
                            </thead>
                            <tbody id="rubricBody">
                                <tr>
                                    <td><strong>Present-Moment Focus</strong></td>
                                    <td><span class="competency-level level-low">Developing</span></td>
                                    <td>Strengthen redirection of temporal displacement</td>
                                </tr>
                                <tr>
                                    <td><strong>Defense Recognition</strong></td>
                                    <td><span class="competency-level level-low">Developing</span></td>
                                    <td>Enhance identification of subtle defensive operations</td>
                                </tr>
                                <tr>
                                    <td><strong>Anxiety Regulation</strong></td>
                                    <td><span class="competency-level level-low">Developing</span></td>
                                    <td>Prioritize co-regulation over accommodation</td>
                                </tr>
                                <tr>
                                    <td><strong>Twin Factors Integration</strong></td>
                                    <td><span class="competency-level level-low">Developing</span></td>
                                    <td>Balance pressure with consistent support</td>
                                </tr>
                                <tr>
                                    <td><strong>Attachment Awareness</strong></td>
                                    <td><span class="competency-level level-low">Developing</span></td>
                                    <td>Recognize historical patterns in present resistance</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="info-box" style="margin-top: var(--space-8);">
                            <h4>Recommended Development Path</h4>
                            <ul style="margin-top: var(--space-3); line-height: 2;">
                                <li>Internalize the Triangle of Conflict framework through daily application</li>
                                <li>Practice present-moment interventions in all clinical encounters</li>
                                <li>Record sessions for detailed defensive operation analysis</li>
                                <li>Seek specialized ISTDP supervision for complex cases</li>
                                <li>Remember: Collusion perpetuates pathology; challenge with support facilitates healing</li>
                            </ul>
                        </div>

                        <div style="text-align: center; margin-top: var(--space-8);">
                            <button class="btn btn-primary" onclick="resetProgress()">
                                Begin New Training Session
                            </button>
                            <button class="btn btn-secondary" onclick="downloadProgress()" style="margin-left: var(--space-4);">
                                Export Assessment Report
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>
                            <span class="icon">◊</span>
                            Clinical Phrase Reference
                        </h2>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; gap: var(--space-4);">
                            <div class="clinical-note" style="border-left-color: var(--primary);">
                                <h4 style="color: var(--primary);">Anxiety Regulation Interventions</h4>
                                <ul style="margin-top: var(--space-3); color: var(--neutral-700); line-height: 2;">
                                    <li>"Shall we take a look at your anxiety so we can help you bring it down?"</li>
                                    <li>"Together we can do what you cannot do alone"</li>
                                    <li>"You don't have to hide your anxiety to protect me"</li>
                                </ul>
                            </div>
                            <div class="clinical-note" style="border-left-color: var(--accent);">
                                <h4 style="color: var(--accent);">Defense Analysis Interventions</h4>
                                <ul style="margin-top: var(--space-3); color: var(--neutral-700); line-height: 2;">
                                    <li>"What is it about this moment with me...?"</li>
                                    <li>"My concern is that your anxiety will get worse"</li>
                                    <li>"Could we pay attention to it together?"</li>
                                </ul>
                            </div>
                            <div class="clinical-note" style="border-left-color: var(--warm);">
                                <h4 style="color: var(--warm);">Attachment Repair Interventions</h4>
                                <ul style="margin-top: var(--space-3); color: var(--neutral-700); line-height: 2;">
                                    <li>"You don't have to protect me from your feelings"</li>
                                    <li>"Let's create a different experience here"</li>
                                    <li>"I can handle your feelings"</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global state
        let currentScenario = 1;
        let scenarioScores = [];
        let totalScenarios = 3;
        let userResponses = {};

        // Page navigation
        function showPage(index) {
            const pages = document.querySelectorAll('.page');
            const tabs = document.querySelectorAll('.nav-tab');
            
            pages.forEach(page => page.classList.remove('active'));
            tabs.forEach(tab => tab.classList.remove('active'));
            
            pages[index].classList.add('active');
            tabs[index].classList.add('active');
        }

        // Triangle of Conflict interaction
        function showTriangleInfo(point) {
            const descriptions = {
                feeling: {
                    title: 'Impulse/Feeling Component',
                    content: `<strong>Core Affective Experience</strong><br><br>
                    The unconscious emotional content defended against by the patient. Clinical manifestations include:
                    <ul style="margin-top: var(--space-3); color: var(--neutral-700);">
                        <li>Aggressive impulses toward attachment figures</li>
                        <li>Profound grief regarding developmental losses</li>
                        <li>Tender affects and loving feelings</li>
                        <li>Guilt regarding destructive impulses</li>
                    </ul>
                    <div class="clinical-note" style="margin-top: var(--space-4);">
                        <strong>Clinical Principle:</strong> Blocked affects inevitably manifest through symptomatic expression or behavioral enactments.
                    </div>`
                },
                anxiety: {
                    title: 'Anxiety Signal Function',
                    content: `<strong>Unconscious Signal of Rising Affect</strong><br><br>
                    Physiological alarm indicating unconscious material approaching consciousness:
                    <ul style="margin-top: var(--space-3); color: var(--neutral-700);">
                        <li>Striated muscle channel: tension, sighing, motor restlessness</li>
                        <li>Smooth muscle channel: gastrointestinal, vestibular, vascular symptoms</li>
                        <li>Cognitive-perceptual disruption: dissociation, derealization</li>
                    </ul>
                    <div class="clinical-note" style="margin-top: var(--space-4);">
                        <strong>Key Intervention:</strong> "That's anxiety. Shall we look at it together so you don't have to get dizzy?"
                    </div>`
                },
                defense: {
                    title: 'Defensive Operations',
                    content: `<strong>Mechanisms to Avoid Affective Experience</strong><br><br>
                    Protective strategies that maintain symptomatology while preventing affective breakthrough:
                    <ul style="margin-top: var(--space-3); color: var(--neutral-700);">
                        <li>Isolation: intellectualization, rationalization, obsessionalization</li>
                        <li>Repressive mechanisms: forgetting, minimization, denial</li>
                        <li>Displacement: temporal, interpersonal, topical shifting</li>
                        <li>Acting out: physical leaving, substance use, self-injury</li>
                    </ul>
                    <div class="clinical-note" style="margin-top: var(--space-4);">
                        <strong>Clinical Reality:</strong> Each unaddressed defense maintains the pathological equilibrium.
                    </div>`
                }
            };

            const descDiv = document.getElementById('triangleDescription');
            const info = descriptions[point];
            descDiv.innerHTML = `<h4>${info.title}</h4>${info.content}`;
            
            // Update active state
            document.querySelectorAll('.triangle-node').forEach(node => node.classList.remove('active'));
            event.target.closest('.triangle-node').classList.add('active');
        }

        // Present-moment practice feedback
        function checkPresentMoment(element, type) {
            const feedbackPanel = document.getElementById('presentMomentFeedback');
            
            // Mark selected
            document.querySelectorAll('#page1 .response-option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });
            element.classList.add('selected');

            const feedbacks = {
                'correct': {
                    score: 100,
                    class: 'correct',
                    title: 'Optimal ISTDP Intervention',
                    content: `<strong>Clinical Rationale:</strong>
                    <ul style="margin-top: var(--space-3); color: var(--neutral-700);">
                        <li>Redirects to immediate therapeutic process</li>
                        <li>Addresses temporal displacement defense</li>
                        <li>Accesses here-and-now relational dynamics</li>
                        <li>Prevents future enactment through present processing</li>
                    </ul>
                    <div class="clinical-note" style="margin-top: var(--space-4);">
                        <strong>Mechanism:</strong> The anticipated binge serves as defense against immediate affective experience in the therapeutic relationship.
                    </div>`
                },
                'displacement': {
                    score: 25,
                    class: 'incorrect',
                    title: 'Collusion with Displacement',
                    content: `<strong>Clinical Error:</strong> Following the patient's defensive trajectory away from present affect.
                    <ul style="margin-top: var(--space-3); color: var(--neutral-700);">
                        <li>Reinforces "there and then" defensive operation</li>
                        <li>Misses immediate therapeutic opportunity</li>
                        <li>Maintains unconscious status of affect</li>
                    </ul>
                    <strong>Corrective Approach:</strong> "What is it about THIS MOMENT with me that's making us think about Saturday?"`
                },
                'support-only': {
                    score: 40,
                    class: 'incorrect',
                    title: 'Support Without Pressure',
                    content: `<strong>Clinical Error:</strong> Empathic response without defensive challenge.
                    <ul style="margin-top: var(--space-3); color: var(--neutral-700);">
                        <li>Validates defensive position</li>
                        <li>Fails to address displacement</li>
                        <li>Maintains pathological equilibrium</li>
                    </ul>
                    <strong>Principle:</strong> Twin factors require simultaneous pressure and support. Isolated support constitutes abandonment.`
                },
                'advice': {
                    score: 30,
                    class: 'incorrect',
                    title: 'Premature Problem-Solving',
                    content: `<strong>Clinical Error:</strong> Bypassing affective work through intellectualized solutions.
                    <ul style="margin-top: var(--space-3); color: var(--neutral-700);">
                        <li>Colludes with intellectualization defense</li>
                        <li>Avoids underlying affective content</li>
                        <li>Reinforces affect as dangerous/irrelevant</li>
                    </ul>
                    <strong>Principle:</strong> Affective processing precedes genuine problem resolution.`
                }
            };

            const feedback = feedbacks[type];
            element.classList.add(feedback.class);

            feedbackPanel.innerHTML = `
                <div class="feedback-header">
                    <h3>${feedback.title}</h3>
                    <span class="score-display">${feedback.score}/100</span>
                </div>
                ${feedback.content}
            `;
            feedbackPanel.classList.add('show');
        }

        // Scenario evaluation with rubric
        function evaluateResponse(scenario, response, element) {
            // Mark selected
            const container = document.getElementById(`scenario${scenario}Options`);
            container.querySelectorAll('.response-option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
                opt.style.pointerEvents = 'none';
            });
            element.classList.add('selected');

            // Rubric scoring
            const rubric = {
                1: { // Anxiety regulation scenario
                    'A': { score: 20, correct: false, feedback: 'Accommodation without regulation' },
                    'B': { score: 100, correct: true, feedback: 'Optimal co-regulation intervention' },
                    'C': { score: 30, correct: false, feedback: 'Deference to medical model' },
                    'D': { score: 10, correct: false, feedback: 'Abandonment response' }
                },
                2: { // Defensive wall scenario
                    'A': { score: 10, correct: false, feedback: 'Complete defensive collusion' },
                    'B': { score: 100, correct: true, feedback: 'Direct defense analysis with support' },
                    'C': { score: 60, correct: false, feedback: 'Partial intervention with displacement' },
                    'D': { score: 20, correct: false, feedback: 'Therapeutic abandonment' }
                },
                3: { // Attachment challenge scenario
                    'A': { score: 40, correct: false, feedback: 'Defensive reassurance' },
                    'B': { score: 100, correct: true, feedback: 'Present-focused affect exploration' },
                    'C': { score: 50, correct: false, feedback: 'Intellectualized displacement' },
                    'D': { score: 30, correct: false, feedback: 'Defensive counter-challenge' }
                }
            };

            const result = rubric[scenario][response];
            element.classList.add(result.correct ? 'correct' : 'incorrect');

            // Store score
            scenarioScores.push(result.score);
            userResponses[`scenario${scenario}`] = response;

            // Generate detailed feedback
            const feedbackPanel = document.getElementById(`scenario${scenario}Feedback`);
            const scenarioFeedback = getDetailedFeedback(scenario, response, result);
            
            feedbackPanel.innerHTML = scenarioFeedback;
            feedbackPanel.classList.add('show');

            // Show next button
            document.getElementById(`next${scenario}`).style.display = 'inline-block';

            // Update progress
            updateProgress();
        }

        function getDetailedFeedback(scenario, response, result) {
            const expertAnalysis = {
                1: {
                    'B': `
                        <h4>Expert Clinical Analysis: Masterful Co-Regulation</h4>
                        <p><strong>Intervention Strengths:</strong></p>
                        <ul style="color: var(--neutral-700);">
                            <li>Direct anxiety naming (avoiding euphemism)</li>
                            <li>Collaborative regulation offer ("together")</li>
                            <li>Symptom-anxiety linkage explicit</li>
                            <li>Challenges dismissive defense</li>
                        </ul>
                        <p style="margin-top: var(--space-4);"><strong>Therapeutic Impact:</strong> Establishes therapist as secure regulatory object.</p>`,
                    'A': `
                        <h4>Analysis: Social vs. Therapeutic Response</h4>
                        <p><strong>Clinical Error:</strong> "Take your time" signals inability to tolerate patient anxiety.</p>
                        <p><strong>Corrective Intervention:</strong> Challenge dismissal while offering co-regulation.</p>`,
                    'C': `
                        <h4>Analysis: Medical Model Collusion</h4>
                        <p><strong>Clinical Error:</strong> Reinforces anxiety as disorder rather than signal function.</p>
                        <p><strong>ISTDP Perspective:</strong> Anxiety signals rising unconscious affect requiring exploration.</p>`,
                    'D': `
                        <h4>Critical Error: Abandonment Response</h4>
                        <p><strong>Attachment Repetition:</strong> Recreates developmental pattern of caregiver withdrawal during distress.</p>`
                }
            };

            const specific = expertAnalysis[scenario]?.[response] || '<p>Consider the intervention\'s impact on therapeutic alliance and defensive structure.</p>';

            return `
                <div class="feedback-header">
                    <h3>${result.correct ? 'Optimal Clinical Response' : 'Suboptimal Intervention'}</h3>
                    <span class="score-display">${result.score}/100</span>
                </div>
                <p style="font-weight: 600; color: var(--primary); margin: var(--space-4) 0;">${result.feedback}</p>
                ${specific}
                <div class="clinical-note" style="margin-top: var(--space-6);">
                    <strong>Core Principle:</strong> Every intervention either facilitates secure attachment or perpetuates pathological patterns.
                </div>
            `;
        }

        function nextScenario(next) {
            document.getElementById(`scenario${next - 1}`).style.display = 'none';
            document.getElementById(`scenario${next}`).style.display = 'block';
            currentScenario = next;
        }

        function updateProgress() {
            const completed = scenarioScores.length;
            const progress = (completed / totalScenarios) * 100;
            document.getElementById('scenarioProgress').style.width = `${progress}%`;
            document.getElementById('scenarioCount').textContent = completed;
            
            if (completed > 0) {
                const avg = Math.round(scenarioScores.reduce((a, b) => a + b, 0) / completed);
                document.getElementById('avgScore').textContent = `${avg}%`;
            }
            
            // Update optimal responses
            const optimal = scenarioScores.filter(s => s === 100).length;
            document.getElementById('streakCount').textContent = optimal;
        }

        function showProgress() {
            showPage(3);
            generateFinalReport();
        }

        function generateFinalReport() {
            const avgScore = Math.round(scenarioScores.reduce((a, b) => a + b, 0) / scenarioScores.length);
            document.getElementById('finalScore').textContent = `${avgScore}%`;
            
            // Determine level
            let level = 'Novice Practitioner';
            if (avgScore >= 90) level = 'Advanced ISTDP Practitioner';
            else if (avgScore >= 70) level = 'Competent Practitioner';
            else if (avgScore >= 50) level = 'Developing Practitioner';
            
            document.getElementById('performanceLevel').textContent = level;
            
            // Update rubric based on performance
            updateRubricScores(avgScore);
        }

        function updateRubricScores(avgScore) {
            const tbody = document.getElementById('rubricBody');
            const level = avgScore >= 80 ? 'high' : avgScore >= 50 ? 'medium' : 'low';
            const levelText = avgScore >= 80 ? 'Proficient' : avgScore >= 50 ? 'Developing' : 'Foundational';
            
            const competencies = [
                { name: 'Present-Moment Focus', feedback: 'Strengthen temporal displacement redirection' },
                { name: 'Defense Recognition', feedback: 'Enhance subtle defense identification' },
                { name: 'Anxiety Regulation', feedback: 'Prioritize co-regulation interventions' },
                { name: 'Twin Factors Integration', feedback: 'Balance pressure with support consistently' },
                { name: 'Attachment Awareness', feedback: 'Recognize historical patterns in resistance' }
            ];
            
            tbody.innerHTML = competencies.map(comp => `
                <tr>
                    <td><strong>${comp.name}</strong></td>
                    <td><span class="competency-level level-${level}">${levelText}</span></td>
                    <td>${comp.feedback}</td>
                </tr>
            `).join('');
        }

        function resetProgress() {
            scenarioScores = [];
            userResponses = {};
            currentScenario = 1;
            
            // Reset UI
            document.querySelectorAll('.response-option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
                opt.style.pointerEvents = 'auto';
            });
            
            document.querySelectorAll('.feedback-panel').forEach(panel => {
                panel.classList.remove('show');
            });
            
            document.querySelectorAll('[id^="next"]').forEach(btn => {
                btn.style.display = 'none';
            });
            
            // Reset scenarios visibility
            document.getElementById('scenario1').style.display = 'block';
            document.getElementById('scenario2').style.display = 'none';
            document.getElementById('scenario3').style.display = 'none';
            
            // Go to scenarios page
            showPage(2);
            updateProgress();
        }

        function downloadProgress() {
            const report = `ISTDP Clinical Training Assessment
Date: ${new Date().toLocaleDateString()}
Overall Performance: ${document.getElementById('finalScore').textContent}
Clinical Level: ${document.getElementById('performanceLevel').textContent}

Scenario Performance:
${scenarioScores.map((score, i) => `Scenario ${i + 1}: ${score}/100`).join('\n')}

Development Recommendations:
- Internalize Triangle of Conflict framework
- Practice present-moment interventions
- Seek specialized ISTDP supervision
- Remember: Collusion perpetuates pathology

Generated by ISTDP Advanced Training Platform`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'istdp-assessment-report.txt';
            a.click();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
        });
    </script>
</body>
</html>